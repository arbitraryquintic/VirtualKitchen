/* Our marketing team is putting together a promotion around Virtual Kitchen's five best-selling cookie recipes. We want to include the total calories and fat for the recipe in the message.

Someone put together a quick query to join the ingredients to an external source for nutritional information:  vk_data.resources.nutrition. 

The results of the query below are correct, but we want to clean up the code so that it is easier to understand.
*/

select
    di.recipe_name, sum(di.calories) as total_calories, sum(cast(replace(di.total_fat, 'g', '') as int)) as total_fat
from (
    select 
        recipe_id,
        recipe_name,
        ingredient,
        first_record,
        calories,
        total_fat
    from (
            select 
                recipe_id,
                recipe_name,
                flat_ingredients.index,
                trim(upper(replace(flat_ingredients.value, '"', ''))) as ingredient
            from vk_data.chefs.recipe
            , table(flatten(ingredients)) as flat_ingredients
        ) as r
    left join (
        select 
            trim(upper(replace(substring(ingredient_name, 1, charindex(',', ingredient_name)), ',', ''))) as ingredient_name,
            min(id) as first_record,
            max(calories) as calories,
            max(total_fat) as total_fat
        from vk_data.resources.nutrition 
        group by 1) as i on r.ingredient = i.ingredient_name
    where (recipe_name = 'birthday cookie' or recipe_name = 'a perfect sugar cookie' or
        recipe_name = 'honey oatmeal raisin cookies' or recipe_name = 'frosted lemon cookies' or
        recipe_name = 'snickerdoodles cinnamon cookies'
          )) di
join vk_data.resources.nutrition n on di.first_record = n.id
group by 1
order by 1
